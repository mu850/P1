<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ø±Ø¬Ø³Ù¹Ø± Ù¾Ø±Ùˆ</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2e7d32; --dark: #263238; --accent: #f1c40f; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #f4f7f6; padding: 10px; margin: 0; direction: rtl; }
        .container { background: white; max-width: 900px; margin: auto; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; }
        h2 { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .form-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 15px; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .f-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; color: #444; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }

        .checkboxes { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px; }
        .btn-calc { grid-column: 1 / -1; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Report Cards */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .report-card { background: var(--dark); color: white; padding: 12px; border-radius: 10px; text-align: center; border-bottom: 4px solid var(--accent); }
        .report-card h4 { margin: 0; font-size: 13px; color: #bbb; }
        .report-card p { margin: 8px 0 0; font-size: 16px; font-weight: bold; color: var(--accent); }

        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #666; }
        .tab-btn.active { border-bottom: 4px solid var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; background: white; margin-top: 5px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 14px; }
        th { background: #37474f; color: white; }

        #resultBox { background: #222; color: white; padding: 15px; border-radius: 10px; margin-top: 15px; display: none; }
        .btn-pdf { background: #c0392b; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px 0; }
        
        .filter-area { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid var(--primary); margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body onload="initApp()">

<div class="container">
    <div class="no-print">
        <h2>Ø¢Ù¹Ø§ Ú†Ú©ÛŒ ÚˆÛŒØ¬ÛŒÙ¹Ù„ Ø±Ø¬Ø³Ù¹Ø±</h2>

        <div class="form-box">
            <div class="f-group"><label>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</label><input type="text" id="cName" placeholder="Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº"></div>
            <div class="f-group"><label>Ú¯Ù†Ø¯Ù… ÙˆØ²Ù† (Ú©Ù„Ùˆ)</label><input type="number" id="wWeight" step="0.01"></div>
            <div class="f-group"><label>Ø¢Ù¹Ø§ Ø±ÛŒÙ¹</label><input type="number" id="aRate" value="120"></div>
            <div class="f-group"><label>Ø§ÛŒÚˆÙˆØ§Ù†Ø³ Ø¢Ù¹Ø§</label><input type="number" id="advA" value="0"></div>
            <div class="checkboxes">
                <label><input type="checkbox" id="noCln"> ØµÙØ§Ø¦ÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <label><input type="checkbox" id="noKat"> Ú©Ù¹ÙˆØªÛŒ Ù†ÛÛŒÚº Ú©Ø±Ù†ÛŒ</label>
                <label><input type="checkbox" id="payByA"> Ø¨Ù„ Ø¢Ù¹Û’ Ø³Û’ Ú©Ø§Ù¹ÛŒÚº</label>
            </div>
            <button class="btn-calc" onclick="calculateBill()">Ø­Ø³Ø§Ø¨ Ú©Ø±ÛŒÚº</button>
        </div>

        <div id="resultBox">
            <div style="display:flex; justify-content:space-between;"><span>Ù¹ÙˆÙ¹Ù„ Ø¨Ù„:</span> <span id="outB" style="color:var(--accent); font-size:20px; font-weight:bold;">0</span></div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;"><span>ØµØ§Ù Ø¢Ù¹Ø§:</span> <span id="outNet" style="color:#2ecc71; font-size:20px;">0</span> Ú©Ù„Ùˆ</div>
            <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button onclick="saveData('Paid')" style="background:#27ae60; color:white; border:none; padding:12px; border-radius:8px; grid-column:span 2; font-weight:bold;">Ù†Ù‚Ø¯ ÙˆØµÙˆÙ„ÛŒ</button>
                <button onclick="saveData('Khata')" style="background:#e67e22; color:white; border:none; padding:12px; border-radius:8px; font-weight:bold;">Ø§Ø¯Ú¾Ø§Ø± Ú©Ú¾Ø§ØªÛ</button>
                <button onclick="document.getElementById('resultBox').style.display='none'" style="background:#666; color:white; border:none; padding:12px; border-radius:8px;">Ú©ÛŒÙ†Ø³Ù„</button>
            </div>
        </div>
        <hr>
    </div>

    <div class="filter-area no-print">
        <label>ÙÙ„Ù¹Ø± ØªØ§Ø±ÛŒØ®:</label>
        <input type="date" id="dateFrom" onchange="render()">
        <input type="date" id="dateTo" onchange="render()">
        <button onclick="downloadPDF()" class="btn-pdf" style="margin:0">ğŸ“¥ PDF Ø±Ù¾ÙˆØ±Ù¹</button>
    </div>

    <div id="reportContent">
        <div id="pdfHeader" style="display:none; text-align:center;">
            <h1 style="color:#2e7d32;">Ø¢Ù¹Ø§ Ú†Ú©ÛŒ Ú©Ú¾Ø§ØªÛ Ø±Ù¾ÙˆØ±Ù¹</h1>
            <p id="pdfDateRange"></p>
        </div>

        <div class="report-grid">
            <div class="report-card"><h4>Ú©Ù„ Ú¯Ù†Ø¯Ù…</h4><p id="repWheat">0 Ú©Ù„Ùˆ</p></div>
            <div class="report-card"><h4>Ú©Ù„ Ø±Ù‚Ù… (Ø¨Ù„)</h4><p id="repCash">0</p></div>
            <div class="report-card"><h4>Ú©Ù¹ÙˆØªÛŒ ÙˆØ²Ù†</h4><p id="repKatW">0 Ú©Ù„Ùˆ</p></div>
            <div class="report-card"><h4>Ú©Ù¹ÙˆØªÛŒ Ø±Ù‚Ù…</h4><p id="repKatC">0</p></div>
        </div>

        <div class="tabs no-print">
            <div class="tab-btn active" onclick="switchTab(event, 'tab1')">Ø±ÙˆØ²Ù…Ø±Û</div>
            <div class="tab-btn" onclick="openSummaryTab(event)">Ù…Ø¬Ù…ÙˆØ¹ÛŒ Ú©Ú¾Ø§ØªÛ</div>
        </div>

        <div id="tab1" class="tab-content active">
            <table id="dailyTbl">
                <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ù†Ø§Ù…</th><th>ÙˆØ²Ù†</th><th>Ø¨Ù„</th><th>Ø­Ø§Ù„Øª</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="tab2" class="tab-content">
            <table id="summaryTbl">
                <thead><tr><th>Ú¯Ø§ÛÚ© Ú©Ø§ Ù†Ø§Ù…</th><th>Ú©Ù„ Ø§Ø¯Ú¾Ø§Ø±</th><th>Ú©Ù„ ÙˆØµÙˆÙ„ÛŒ</th><th>Ø¨Ù‚Ø§ÛŒØ§</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const PISAI_RATE = 3.00, SAFAI_RATE = 1.20, KATOTI_PERCENT = 0.050;
    let db = [];

    function initApp() {
        db = JSON.parse(localStorage.getItem('chaki_db_final')) || [];
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log(e));
        }
        render();
    }

    function calculateBill() {
        const name = document.getElementById('cName').value.trim();
        const weight = parseFloat(document.getElementById('wWeight').value) || 0;
        const rate = parseFloat(document.getElementById('aRate').value) || 0;
        const adv = parseFloat(document.getElementById('advA').value) || 0;

        if (!name || weight <= 0) { alert("Ù†Ø§Ù… Ø§ÙˆØ± ÙˆØ²Ù† Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº"); return; }

        const noCln = document.getElementById('noCln').checked;
        const noKat = document.getElementById('noKat').checked;
        const payByA = document.getElementById('payByA').checked;

        let fee = (weight * PISAI_RATE) + (noCln ? 0 : (weight * SAFAI_RATE));
        let katW = weight * KATOTI_PERCENT;
        let katC = noKat ? (katW * rate) : 0;
        let totalBill = fee + katC;
        let netFlour = weight - (noKat ? 0 : katW) - adv;

        if (payByA) { netFlour -= (totalBill / rate); totalBill = 0; }

        document.getElementById('outB').innerText = totalBill.toFixed(0);
        document.getElementById('outNet').innerText = netFlour.toFixed(2);
        document.getElementById('resultBox').style.display = 'block';

        window.currentData = { 
            id: Date.now(), name, weight, totalBill, 
            katW: noKat ? 0 : katW, katC: noKat ? katC : 0,
            paid: 0, balance: totalBill, date: new Date().toISOString().split('T')[0] 
        };
    }

    function saveData(status) {
        if (!window.currentData) return;
        let data = { ...window.currentData, status };
        if (status === 'Paid') { data.paid = data.totalBill; data.balance = 0; }
        db.push(data);
        localStorage.setItem('chaki_db_final', JSON.stringify(db));
        document.getElementById('resultBox').style.display = 'none';
        document.getElementById('cName').value = '';
        document.getElementById('wWeight').value = '';
        render();
    }

    function render() {
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const dailyBody = document.querySelector('#dailyTbl tbody');
        dailyBody.innerHTML = '';

        let stats = { w:0, c:0, kw:0, kc:0 };

        db.sort((a,b) => b.id - a.id).forEach(item => {
            if ((from && item.date < from) || (to && item.date > to)) return;

            stats.w += item.weight; stats.c += item.totalBill;
            stats.kw += item.katW; stats.kc += item.katC;

            dailyBody.innerHTML += `<tr>
                <td>${item.date}</td><td>${item.name}</td><td>${item.weight}</td>
                <td>${item.totalBill.toFixed(0)}</td>
                <td style="color:${item.status === 'Paid' ? 'green' : 'red'}">${item.status === 'Paid' ? 'Ù†Ù‚Ø¯' : 'Ø§Ø¯Ú¾Ø§Ø±'}</td>
            </tr>`;
        });

        document.getElementById('repWheat').innerText = stats.w.toFixed(1) + " Ú©Ù„Ùˆ";
        document.getElementById('repCash').innerText = stats.c.toFixed(0);
        document.getElementById('repKatW').innerText = stats.kw.toFixed(2) + " Ú©Ù„Ùˆ";
        document.getElementById('repKatC').innerText = stats.kc.toFixed(0);
    }

    function openSummaryTab(e) {
        switchTab(e, 'tab2');
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const summaryBody = document.querySelector('#summaryTbl tbody');
        summaryBody.innerHTML = '';

        const aggregated = {};
        db.forEach(item => {
            if ((from && item.date < from) || (to && item.date > to)) return;
            if (!aggregated[item.name]) aggregated[item.name] = { total:0, paid:0, bal:0 };
            aggregated[item.name].total += item.totalBill;
            aggregated[item.name].paid += item.paid;
            aggregated[item.name].bal += item.balance;
        });

        for (const name in aggregated) {
            summaryBody.innerHTML += `<tr>
                <td>${name}</td><td>${aggregated[name].total.toFixed(0)}</td>
                <td>${aggregated[name].paid.toFixed(0)}</td>
                <td style="color:red; font-weight:bold">${aggregated[name].bal.toFixed(0)}</td>
            </tr>`;
        }
    }

    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function downloadPDF() {
        const element = document.getElementById('reportContent');
        const header = document.getElementById('pdfHeader');
        header.style.display = 'block';
        html2pdf().from(element).set({ margin: 10, filename: 'Chaki_Report.pdf', html2canvas: { scale: 2 } }).save().then(() => {
            header.style.display = 'none';
        });
    }
</script>
</body>
</html>
